{% extends 'sessions/base.html' %}

{% block subnav %}
    {% if not room_group %}
        <a id="session-reservations" class="nav-link {{ 'active' if 'view-reservations' in request.path else 'disabled' }}" href="{{ url_for('SessionView:view_session_reservations', session_id=session.id) }}">View Reservations</a>
        <a id="session-seats" class="nav-link {{ 'active' if 'view-session-seats' in request.path else 'disabled' }}" href="{{ url_for('SessionView:view_session_seats', session_id=session.id) }}">Assign Seats</a>
    {% else %}
        <a id="room-group-reservations" class="nav-link {{ 'active' if 'view-room-group-reservations' in request.path else 'disabled' }}" href="{{ url_for('SessionView:view_room_group_reservations', room_group_id=room_group.id) }}">View Reservations</a>
        <a id="room-group-seats" class="nav-link {{ 'active' if 'view-room-group-seats' in request.path else 'disabled' }}" href="{{ url_for('SessionView:view_room_group_seats', room_group_id=room_group.id) }}">Assign Seats</a>
        <a id="room-group-capacities" class="nav-link {{ 'active' if 'view-room-group-capacities' in request.path else 'disabled' }}" href="{{ url_for('SessionView:view_room_group_capacities', room_group_id=room_group.id) }}">Edit Capacities</a>
    {% endif %}
{% endblock %}

{% block body_content %}
    <div class="form-group col-md-12">
        <h4>Session Details:</h4>
        <table id="student-table"  class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th data-toggle="tooltip" data-placement="top" title="Session Name">Name</th>
                    <th data-toggle="tooltip" data-placement="top" title="Session Date">Date</th>
                    <th data-toggle="tooltip" data-placement="top" title="Session Time">Time</th>
                    <th data-toggle="tooltip" data-placement="top" title="Session Room">Room</th>
                    <th data-toggle="tooltip" data-placement="top" title="Seats Available">Seats Available</th>
                    <th data-toggle="tooltip" data-placement="top" title="Session Capacity">Session Capacity</th>
                </tr>
            </thead>
            <tbody>
                {% for session in sessions %}
                    <tr>
                        <td data-th="Session Name">
                            {{ session.name }}
                        </td>
                        <td data-th="Session Date">
                            {{ session.date.strftime('%m/%d/%Y') }}
                        </td>
                        <td data-th="Session Time">
                            {{ session.schedStartTime|datetimeformat + ' - ' + session.schedEndTime|datetimeformat }}
                        </td>
                        <td data-th="Session Room">
                            {{ session.room }}
                        </td>
                        <td data-th="Seats Available">
                            {{ get_seats_available(session.id) }}
                        </td>
                        <td data-th="Session Capacity">
                            <input id="{{ session.id }}" class="capacities" type="number" min="0" value="{{ session.capacity }}" required/>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <th class="no-border-top" colspan="5">Total Room Capacity</th>
                    <th class="no-border-top">{{ room_group.capacity }}</th>
                </tr>
            </tfoot>
        </table>
        <button type="button" class="btn blue btn-primary margin-top-10" id="edit-capacities">Save Capacity Edits</button>
    </div>
    <script>
        $(document).ready(function () {
            $('#edit-capacities').click(function () {
                let capacities = document.getElementsByClassName('capacities')
                let capacities_list = []
                for (let i = 0; i < capacities.length; i++) {
                    capacities_list.push({
                        'session_id': capacities[i].id,
                        'capacity': parseInt(capacities[i].value)
                    })
                }

                $.ajax({
                    type: "POST",
                    url: "{{ url_for('SessionView:update_room_group_capacities') }}",
                    data: JSON.stringify({
                        'capacities': capacities_list,
                        'room_group_id': {{ room_group.id }}
                    }),
                    contentType: 'application/json;charset=UTF-8',
                    success: function (response) {
                        window.location.reload(true);
                    },
                    error: function (error) {
                        window.location.reload(true);
                    }
                });
            });
        });
    </script>
{% endblock %}