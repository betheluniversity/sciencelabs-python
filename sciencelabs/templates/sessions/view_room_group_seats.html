{% extends 'sessions/base.html' %}

{% block subnav %}
    <a id="session-reservations" class="nav-link {{ 'active' if 'view-room-group-reservations' in request.path else 'disabled'}}" href="{{ url_for('SessionView:view_room_group_reservations', room_group_id=room_group.id) }}">View Reservations</a>
    <a id="session-seats" class="nav-link {{ 'active' if 'view-room-group-seats' in request.path else 'disabled'}}" href="{{ url_for('SessionView:view_room_group_seats', room_group_id=room_group.id) }}">Assign Seats</a>
{% endblock %}

{% block body_content %}
    <div class="form-group col-md-12">
        {% if not students_and_courses %}
            <h4>No students have signed in yet.</h4>
        {% else %}
            <h2>Room Group Capacity: {{ room_group.capacity }}</h2>
            <h4>Session Details:</h4>
            <table id="student-table"  class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th data-toggle="tooltip" data-placement="top" title="Session Name">Name</th>
                        <th data-toggle="tooltip" data-placement="top" title="Session Date">Date</th>
                        <th data-toggle="tooltip" data-placement="top" title="Session Time">Time</th>
                        <th data-toggle="tooltip" data-placement="top" title="Session Room">Room</th>
                        <th data-toggle="tooltip" data-placement="top" title="Session Capacity">Session Capacity</th>
                        <th data-toggle="tooltip" data-placement="top" title="Session Zoom Url">Zoom Url</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in sessions %}
                        <tr>
                            <td>
                                {{ session.name }}
                            </td>
                            <td>
                                {{ session.date.strftime('%m/%d/%Y') }}
                            </td>
                            <td>
                                {{ session.schedStartTime|datetimeformat + ' - ' + session.schedEndTime|datetimeformat }}
                            </td>
                            <td>
                                {{ session.room }}
                            </td>
                            <td>
                                {{ session.capacity }}
                            </td>
                            <td>
                                <a href="{% if session.zoom_url %}{{ session.zoom_url }}{% endif %}">{% if session.zoom_url %}{{ session.zoom_url }}{% endif %}</a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <br/>
            <h4>Signed In Students:</h4>
            <table id="student-table"  class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th data-toggle="tooltip" data-placement="top" title="Student Name">Name</th>
                        <th data-toggle="tooltip" data-placement="top" title="Courses Signed Up For">Courses Signed Up For</th>
                        <th data-toggle="tooltip" data-placement="top" title="Attending Session Virtually">Attending Virtually</th>
                        <th data-toggle="tooltip" data-placement="top" title="Seat Number Assigned">Seat Assigned (0 if unassigned - N/A if virtual)</th></tr>
                </thead>
                <tbody>
                    {% for student, courses in students_and_courses.items() %}
                        <tr>
                            <td>{{ student.firstName }} {{ student.lastName }}</td>
                            <td>
                                <ul>
                                    {% for course in courses %}
                                        <li>{{ course.dept }}{{ course.course_num }}</li>
                                    {% endfor %}
                                    {% if student.otherCourse and student.otherCourseName %}
                                        <li>{{ student.otherCourseName }} <span id="darkblue" class="button-labels">Other</span></li>
                                    {% endif %}
                                </ul>
                            </td>
                            <td>
                                {% if student.online %}
                                    Yes
                                {% else %}
                                    No
                                {% endif %}
                            </td>
                            <td>
                                {% if not student.online %}
                                    {% set reservation = get_reservation(sessions, student.id) %}
                                    <input id="{{ student.id }}" class="seats" type="number" min="0" max="{{ session.capacity }}" value="{% if reservation.seat_number %}{{ reservation.seat_number }}{% else %}0{% endif %}">
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
        <button type="button" class="btn blue btn-primary margin-top-10" id="edit-seats">Save Seat Edits</button>
    </div>
    <script>
        $(document).ready(function () {
            $('#edit-seats').click(function () {
                let seats = document.getElementsByClassName('seats')
                let seat_list = []
                for (let i = 0; i < seats.length; i++) {
                    seat_list.push({
                        'user_id': seats[i].id,
                        'seat_number': parseInt(seats[i].value)
                    })
                }
                $.ajax({
                    type: "POST",
                    url: "{{ url_for('SessionView:update_room_group_assigned_seats') }}",
                    data: JSON.stringify({
                        'seats': seat_list,
                        'room_group_id': {{ room_group.id }}
                    }),
                    contentType: 'application/json;charset=UTF-8',
                    success: function (response) {
                        window.location.reload(true);
                    },
                    error: function (error) {
                        window.location.reload(true);
                    }
                });
            });

        });
    </script>
{% endblock %}