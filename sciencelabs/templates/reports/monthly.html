{% extends 'reports/base.html' %}

{% block semester_switch %}{% endblock %}

{% block header %}{% endblock %}

{% block body_content %}
    <div class="form-row">
        <div style="text-align: right;" class="form-group col-md-12">
            {# TODO MAKE SURE TO UPDATE WHEN CONNECTING TO DATABASES #}
            <p>
                {% set dates = [] %}
                {% set year = [] %}
                {% for session in sessions %}
                    {% if ((session.date|string)[5:7]) not in dates %}
                        {% if ((session.date|string)[5:7]) %}
                        <p style="display: none;">{{ dates.append((session.date|string)[5:7]) }}</p>
                        <p style="display: none;">{{ year.append((session.date|string)[:4]) }}</p>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            {% for date in dates|sort %}
                {% if date %}
                    <a style="text-decoration: none" class="month-nav {{ 'active' if ((year[loop.index0]|string) + '/' + ((dates|sort)[loop.index0]|int)|string) in request.path else 'disabled'}}" href="{{ url_for('ReportView:month', year=year[loop.index0], month=(dates|sort)[loop.index0]|int) }}">{{ months[date|int - 1][:3] }}</a>&emsp;
                {% endif %}
            {% endfor %}
            </p>
        </div>
    </div>

   <div class="custom-default row">
       <div class="col-md-8">
           <form>
               <div class="form-row">
                   <div style="text-align: right;" class="form-group col-md-12">
                       <div class="semester-selector">
                            <div class="btn-group">
                                {{ macros.semester_selector(semester_list) }}
                            </div>
                       </div>
                   </div>
               </div>
                <div class="form-row">
                    <div class="form-group col-md-12">
                        <div class="header card">
                            <div class="card-body btn-group">
                                    {# TODO PUT IN MONTH YEAR #}
                                    <p style="padding: 0px; margin: 0px">Attendance for {{ months[selected_month|int - 1] }} {{ selected_year }}</p>
                                <a href="{{ url_for('ReportView:export_monthly_summary_csv', year=selected_year, month=selected_month) }}" style="right: 175px;" class="csv-button  btn btn-primary">CSV Summary Export</a>
                                <a href="{{ url_for('ReportView:export_monthly_detail_csv') }}" class="csv-button btn btn-primary">CSV Detail Export</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-12">
                        {# TODO MAKE SURE TO UPDATE WHEN CONNECTING TO DATABASES #}
                        <h4>Schedule Statistics for Closed Sessions during {{ months[selected_month|int - 1] }}</h4>
                    </div>
                </div>
                {# TODO FILL TABLE #}
                <table id="closed-table"  class="table table-striped table-bordered" style="width:100%">
                    <thead>
                        <tr>
                            <th>Schedule Name</th>
                            <th>DOW</th>
                            <th>Schedule Time</th>
                            <th>Total Attendance</th>
                            <th>% Total</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% set total_attendance = [0] %}
                    {% for schedule in schedule_info %}
                        {% for session in monthly_sessions %}
                            {% set session_schedule = schedule_.get_schedule_from_session(session.id) %}
                            {% set attendance = session_.get_session_attendees(session.id) %}
                            {% if schedule.id == session_schedule.id %}
                                {% if total_attendance.append(total_attendance.pop() + attendance.count() + session.anonStudents) %}{% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% set total_attendance_per_schedule = [0] %}
                    {% for schedule in schedule_info %}
                        {% set total_attendance_per_schedule = [0] %}
                        {% for session in monthly_sessions %}
                            {% set session_schedule = schedule_.get_schedule_from_session(session.id) %}
                            {% set attendance = session_.get_session_attendees(session.id) %}
                            {% if schedule.id == session_schedule.id %}
                                {% if total_attendance_per_schedule.append(total_attendance_per_schedule.pop() + attendance.count() + session.anonStudents) %}{% endif %}
                            {% endif %}
                        {% endfor %}
                        <tr>
                            <td>{{ schedule.name }}</td>
                            <td>{{ day_abbr[schedule.dayofWeek] }}</td>
                            <td>{{ schedule.startTime|datetimeformat }} - {{ schedule.endTime|datetimeformat }}</td>
                            <td>{{ total_attendance_per_schedule[0] }}</td>
                            <td>{{ ((total_attendance_per_schedule[0] / total_attendance[0])*100)|round(1) }}%</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                    <tfoot>
                        {% if unscheduled_sessions %}
                        {% set total_unscheduled = [0] %}
                        {% for sessions in unscheduled_sessions %}
                            {% if total_unscheduled.append(total_unscheduled.pop() + (user_.get_session_students(sessions.id)|length) + sessions.anonStudents) %}{% endif %}
                        {% endfor %}
                        {% if total_attendance.append(total_attendance.pop() + total_unscheduled[0]) %}{% endif %}
                        <tr>
                            <th style="border-top: none;" colspan="3">Unscheduled Sessions</th>
                            {# TODO THESE ARE JUST  #}
                            <th style="border-top: none;">{{ total_unscheduled[0] }}</th>
                            <th style="border-top: none;">{{ ((total_unscheduled[0] / total_attendance[0])*100)|round(2) }}%</th>
                        </tr>
                        {% else %}
                            <tr>
                                <th style="border-top: none;" colspan="3">Unscheduled Sessions</th>
                                {# TODO THESE ARE JUST  #}
                                <th style="border-top: none;">0</th>
                                <th style="border-top: none;">???</th>
                            </tr>
                        {% endif %}

                        <tr>
                            <th style="border-top: none;" colspan="3">Total</th>
                            <th style="border-top: none;">{{ total_attendance[0] }}</th>
                        </tr>
                    </tfoot>
                </table>

                <div class="form-row">
                    <div class="form-group col-md-12">
                        {# TODO MAKE SURE TO UPDATE WHEN CONNECTING TO DATABASES #}
                        <h4>Session Statistics for {{ months[selected_month|int - 1] }}</h4>
                    </div>
                </div>
                {# TODO FILL TABLE #}
                <table id="table"  class="table table-striped table-bordered" style="width:100%">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Date</th>
                            <th>DOW</th>
                            <th>Scheduled Time</th>
                            <th>Total Attendance</th>
                            <th>Report</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% set total_attendance = [0] %}
                    {% for session in monthly_sessions %}
                        {% if session.schedule_id %}
                        <tr>
                            <td>{{ session.name }}</td>
                            <td>{{ session.date.strftime('%m/%d/%Y') }}</td>
                            <td>{{ day_abbr[(cal.weekday(((session.date|string)[:4])|int, ((session.date|string)[5:7])|int, ((session.date|string)[8:])|int) + 1) % 7] }}</td>
                            <td>{{ session.schedStartTime|datetimeformat }} - {{ session.schedEndTime|datetimeformat }}</td>
                            <td>
                                {% set attendance = session_.get_session_attendees(session.id) %}
                                {% if total_attendance.append(total_attendance.pop() + (attendance.count() + session.anonStudents)) %}{% endif %}
                                {{ attendance.count() + session.anonStudents }}
                            </td>
                            <td><a href='{{ url_for('ReportView:view_session', session_id=session.id) }}' id="darkblue" class="btn btn-primary">View</a></td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                    {% for unscheduled in unscheduled_sessions %}
                        <tr>
                            <td>{{ unscheduled.name }}</td>
                            <td>{{ unscheduled.date.strftime('%m/%d/%Y') }}</td>
                            <td>{{ day_abbr[(cal.weekday(((unscheduled.date|string)[:4])|int, ((unscheduled.date|string)[5:7])|int, ((unscheduled.date|string)[8:])|int) + 1) % 7] }}</td>
                            <td>{{ unscheduled.schedStartTime }} - {{ unscheduled.schedEndTime  }}</td>
                            <td>{{ user_.get_session_students(unscheduled.id)|length + unscheduled.anonStudents }}</td>
                            {% if total_attendance.append(total_attendance.pop() + (user_.get_session_students(unscheduled.id)|length + unscheduled.anonStudents)) %}{% endif %}
                            <td><a href='{{ url_for('ReportView:view_session', session_id=unscheduled.id) }}' id="darkblue" class="btn btn-primary">View</a></td>
                        </tr>
                    {% endfor %}
                    </tbody>
                    <tfoot>
                        <th style="border-top: none;" colspan="4">Total</th>
                        <th style="border-top: none;">{{ total_attendance[0] }}</th>
                    </tfoot>
                </table>

            </form>
        </div>
        <div class="col-md-4">
            <div class="sub-info card info">
                <div class="card-body">
                    <p class="card-text">
                        This page contains schedule and session statistics for the term and month listed at the top of
                        the page.
                    </p>
                    <p class="card-text">
                        Monthly schedule and session data is <strong>sortable</strong>; click on the arrow next to any
                        column header to sort by the column field.
                    </p>
                    <p class="card-text">
                       To view term data from a different <strong>term</strong>, choose an option from the term menu in
                       the upper right hand corner of the page and press the  <span class="button-labels">Set</span>
                        button.
                    </p>
                    <p class="card-text">
                        <strong>Set Term Warning:</strong><br>
                        Within each section of reports (except cumulative reports), the term can be changed. When
                        logging in to the application, the default term will be the current term. If the term is changed
                        in one reporting section, the newly set term will be maintained across all sections of reports
                        until set to a new term again.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready( function () {
            $.extend($.fn.dataTableExt.oStdClasses, {
                // give some foundation classes to our controls
                sLength: 'large-4 columns ',
                sFilter: 'large-12 columns ',
            });

            var table = $('#closed-table').DataTable( {
                "aaSorting": [],
                "bPaginate": false,
                "bLengthChange": false,
            });


        });

        $(document).ready( function () {
            var table = $('#table').DataTable( {
                "aaSorting": [1, 'asc'],
                "bPaginate": false,
                "bLengthChange": false,
            });
        });
    </script>


{% endblock %}