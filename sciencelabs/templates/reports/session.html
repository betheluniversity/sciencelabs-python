{% extends 'reports/base.html' %}

{% block semester_switch %}{% endblock %}

{% block header %}{% endblock %}

{% block body_content %}
   <div class="custom-large row">
        <div class="col-md-8">
            <form>
                <div class="form-row">
                    <div style="text-align: right;" class="form-group col-md-12">
                        <div class="semester-selector">
                            <div class="btn-group">
                                {{ macros.semester_selector(semester_list) }}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-12">
                        <div class="header card">
                            <div class="card-body btn-group">
                                <p style="padding: 0px; margin: 0px">View session reports</p>
                                <a href="" class="csv-button btn btn-primary">CSV Export</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-12">
                        {# TODO MAKE SURE TO UPDATE WHEN CONNECTING TO DATABASES #}
                        <p>
                            {% set dates = [] %}
                            {% for session in sessions %}
                                {% if ((session.date|string)[5:7]) not in dates %}
                                    <p style="display: none;">{{ dates.append((session.date|string)[5:7]) }}</p>
                                {% endif %}
                            {% endfor %}
                        {% for date in dates %}
                            {% if date %}
                                <a style="text-decoration: none;" href="#{{ months[date|int - 1] }}">{{ months[date|int - 1] }}</a>&emsp;
                            {% endif %}
                        {% endfor %}
                        </p>
                    </div>
                </div>
                {# TODO FILL TABLE #}
                {% for date in dates %}
                    <h2 style="margin-top: 20px;" id="{{ months[date|int - 1] }}">{{ months[date|int - 1] }}</h2>
                    <table id="{{ date|int }}"  class="table table-striped table-bordered" style="width:100%">
                        <thead>
                        <tr>
                            <th>Date</th>
                            <th>Name</th>
                            <th>DOW</th>
                            <th>Time</th>
                            <th>Attendance</th>
                            <th>Tutors</th>
                            <th>Report</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% set total_attendance = [0] %}
                        {% for session in sessions %}
                            {% if ((session.date|string)[5:7]) == date %}
                                <tr>
                                    <td>{{ session.date.strftime('%m/%d/%Y') }}</td>
                                    <td>{{ session.name }}</td>
                                    <td>
                                        {% set schedule = session_.get_dayofWeek_from_session(session.id) %}
                                        {{ day_abbr[schedule.dayofWeek] }}
                                    </td>
                                    <td>{{ session.startTime|datetimeformat }} - {{ session.endTime|datetimeformat }}</td>
                                    <td>
                                        {% set attendance = session_.get_session_students(session.id) %}
                                        {{ attendance|length }}
                                        {% if total_attendance.append(total_attendance.pop() + (attendance|length)) %}{% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="show-tutors btn btn-primary">Show</button>
                                        <div style="display:none;margin-top:10px" class="text-left">
                                            {% set tutors = session_.get_session_tutors(session.id) %}
                                            {% for tutor in tutors %}
                                                {{ tutor.firstName }} {{ tutor.lastName }}
                                                {% if tutor.lead %}
                                                    <span class="button-labels">Lead</span>
                                                {% endif %}
                                                <br />
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td>
                                        <a href='{{ url_for('ReportView:view_session', session_id=session.id) }}' id="darkblue" class="btn btn-primary">View</a>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th style="border-top: none;" colspan="4" >
                                    Total
                                </th>
                                <th style="border-top: none;">
                                    {{ total_attendance[0] }}
                                </th>
                            </tr>
                        </tfoot>
                    </table>
                {% endfor %}
            </form>
        </div>
        <div class="col-md-4">
            <div class="sub-info card info">
                <div class="card-body">
                    <p class="card-text">
                        All {{ app_settings['LAB_TITLE'] }} session reports for the term given at the top of the page are listed along with
                        their total attendance. This reporting section gives an archive of all session reports. If you
                        would like to edit a report for the current term, go to the closed sessions section of the
                        session tab.
                    </p>
                    <p class="card-text">
                        For further information concerning a session report, click on the
                        <span id="darkblue" class="button-labels">View</span> button next to the session date
                        corresponding to a given session.
                    </p>
                    <p class="card-text">
                        To view session report data from a different term, choose an option from the term menu in the
                        upper right hand corner of the page and press the <span class="button-labels">Set</span> button.

                    </p>
                    <p class="card-text">
                        <strong>Set Term Warning:</strong><br>
                        Within each section of reports (except cumulative reports), the term can be changed. When
                        logging in to the application, the default term will be the current term. If the term is changed
                        in one reporting section, the newly set term will be maintained across all sections of reports
                        until set to a new term again.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready( function () {
            {% for date in dates %}
                var table = $('#{{ date|int }}').DataTable( {
                    "bPaginate": false,
                    "bLengthChange": false,
                    "bFilter": false,
                    "bInfo": false
                });
            {% endfor %}

            $(".show-tutors").click(function() {
                $(this).next().toggle();
                if($(this).text() !== 'Show')
                    $(this).text('Show');
                else
                    $(this).text('Hide');
            });
        });
    </script>
{% endblock %}